-- =====================================================
-- üí¨ POL√çTICAS RLS PARA CHAT GLOBAL
-- =====================================================
-- Execute no Supabase SQL Editor

-- 1Ô∏è‚É£ HABILITAR RLS
ALTER TABLE global_chat_messages ENABLE ROW LEVEL SECURITY;

-- 2Ô∏è‚É£ REMOVER POL√çTICAS ANTIGAS (se existirem)
DROP POLICY IF EXISTS "Anyone can view chat messages" ON global_chat_messages;
DROP POLICY IF EXISTS "Authenticated users can insert messages" ON global_chat_messages;
DROP POLICY IF EXISTS "Users can update own messages" ON global_chat_messages;
DROP POLICY IF EXISTS "Users can delete own messages" ON global_chat_messages;

-- 3Ô∏è‚É£ TODOS AUTENTICADOS PODEM VER
CREATE POLICY "Authenticated users can view messages" ON global_chat_messages
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- 4Ô∏è‚É£ TODOS AUTENTICADOS PODEM INSERIR
CREATE POLICY "Authenticated users can insert messages" ON global_chat_messages
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

-- 5Ô∏è‚É£ USU√ÅRIOS PODEM ATUALIZAR SUAS PR√ìPRIAS MENSAGENS
CREATE POLICY "Users can update own messages" ON global_chat_messages
  FOR UPDATE
  USING (auth.uid() = user_id);

-- 6Ô∏è‚É£ USU√ÅRIOS PODEM DELETAR SUAS PR√ìPRIAS MENSAGENS
CREATE POLICY "Users can delete own messages" ON global_chat_messages
  FOR DELETE
  USING (auth.uid() = user_id);

-- 7Ô∏è‚É£ ADMINS E PROFISSIONAIS PODEM MODERAR (n√£o precisa filtrar por email, todos autenticados podem)
-- Esta pol√≠tica √© opcional - pode comentar se quiser que todos tenham mesmos direitos
-- CREATE POLICY "Admins can manage all messages" ON global_chat_messages
--   FOR ALL
--   USING (auth.role() = 'authenticated');

-- ‚úÖ VERIFICAR POL√çTICAS CRIADAS
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE tablename = 'global_chat_messages';

-- ‚úÖ TESTAR
SELECT '‚úÖ Pol√≠ticas RLS configuradas com sucesso!' as status;

