import React, { useState, useEffect, useRef } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { ArrowLeft, Send, Loader2, Brain, Volume2, VolumeX, Mic, MicOff } from 'lucide-react'
import { useNoaPlatform } from '../contexts/NoaPlatformContext'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import { getNoaAssistantIntegration } from '../lib/noaAssistantIntegration'
import { getNoaTrainingSystem } from '../lib/noaTrainingSystem'

const PatientNOAChat: React.FC = () => {
  const navigate = useNavigate()
  const [searchParams] = useSearchParams()
  const { user } = useAuth()
  const { sendInitialMessage } = useNoaPlatform()
  
  // Verificar se veio do dashboard para iniciar avalia√ß√£o
  const shouldStartAssessment = searchParams.get('startAssessment') === 'true'
  
  // Usar o MESMO sistema do bal√£o flutuante
  const assistantIntegration = getNoaAssistantIntegration()
  const trainingSystem = getNoaTrainingSystem()
  
  const [messages, setMessages] = useState<Array<{
    role: 'user' | 'noa'
    content: string
    timestamp: Date
  }>>([])
  const [inputMessage, setInputMessage] = useState('')
  const [isTyping, setIsTyping] = useState(false)
  const [isResponding, setIsResponding] = useState(false) // Novo estado para quando a resposta est√° chegando
  const [avatarUrl, setAvatarUrl] = useState<string>('https://via.placeholder.com/200x200/8B5CF6/FFFFFF?text=N')
  const [isInitialized, setIsInitialized] = useState(false)
  const [hasWelcomed, setHasWelcomed] = useState(false)
  const [sentInitialMessage, setSentInitialMessage] = useState(false)
  const [audioEnabled, setAudioEnabled] = useState(true) // Controle de √°udio
  const [isRecording, setIsRecording] = useState(false) // Estado de grava√ß√£o
  const sendingRef = useRef(false) // Ref para proteger contra duplica√ß√£o
  const recognitionRef = useRef<any>(null) // Ref para Speech Recognition
  
  // Fun√ß√£o para ler texto com voz feminina
  const speakWithVoice = (text: string) => {
    if ('speechSynthesis' in window) {
      // Cancelar qualquer fala anterior
      window.speechSynthesis.cancel()
      
      const utterance = new SpeechSynthesisUtterance(text)
      
      // Configurar para voz feminina
      utterance.lang = 'pt-BR'
      utterance.rate = 0.9 // Velocidade natural
      utterance.pitch = 1.2 // Tom mais agudo (voz feminina)
      utterance.volume = 0.8
      
      // Tentar encontrar voz feminina em portugu√™s
      const voices = window.speechSynthesis.getVoices()
      const ptBRFemaleVoice = voices.find(voice => 
        voice.lang.includes('pt') && voice.name.toLowerCase().includes('female')
      ) || voices.find(voice => voice.lang.includes('pt'))
      
      if (ptBRFemaleVoice) {
        utterance.voice = ptBRFemaleVoice
      }
      
      // Eventos para controlar o v√≠deo
      utterance.onstart = () => {
        console.log('üîä Iniciando leitura de voz...')
        setIsResponding(true)
      }
      
      utterance.onend = () => {
        console.log('‚úÖ Leitura conclu√≠da')
        setIsResponding(false)
      }
      
      utterance.onerror = () => {
        console.error('‚ùå Erro na leitura de voz')
        setIsResponding(false)
      }
      
      window.speechSynthesis.speak(utterance)
    } else {
      console.warn('‚ö†Ô∏è Web Speech API n√£o dispon√≠vel')
    }
  }

  // Buscar avatar da N√¥a no Supabase (mesmo do bal√£o flutuante)
  useEffect(() => {
    const fetchAvatarUrl = async () => {
      try {
        console.log('üîç Buscando avatar da N√¥a no Supabase...')
        const { data, error } = await supabase.storage
          .from('avatar')
          .list('', {
            limit: 1,
            sortBy: { column: 'created_at', order: 'desc' }
          })

        if (error) {
          console.warn('‚ùå Erro ao buscar avatar:', error)
          return
        }

        if (data && data.length > 0) {
          const { data: { publicUrl } } = supabase.storage
            .from('avatar')
            .getPublicUrl(data[0].name)
          
          console.log('‚úÖ Avatar da N√¥a encontrado:', publicUrl)
          const urlWithCache = `${publicUrl}?t=${Date.now()}`
          setAvatarUrl(urlWithCache)
        }
      } catch (error) {
        console.warn('‚ùå Erro ao buscar avatar da N√¥a:', error)
      }
    }

    fetchAvatarUrl()
  }, [])

  // Parar √°udio quando componente desmontar (mudan√ßa de rota)
  useEffect(() => {
    return () => {
      // Limpar ao desmontar componente
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel()
      }
      // Parar grava√ß√£o se estiver ativa
      if (recognitionRef.current) {
        recognitionRef.current.stop()
      }
      console.log('üîá √Åudio cancelado ao sair da p√°gina')
    }
  }, [])
  
  // Inicializar Speech Recognition
  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition
      recognitionRef.current = new SpeechRecognition()
      
      recognitionRef.current.continuous = false
      recognitionRef.current.interimResults = false
      recognitionRef.current.lang = 'pt-BR'
      
      recognitionRef.current.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript
        setInputMessage(transcript)
        setIsRecording(false)
        
        // Auto-enviar ap√≥s 1 segundo
        setTimeout(() => {
          if (transcript.trim()) {
            handleSendMessage()
          }
        }, 1000)
      }
      
      recognitionRef.current.onerror = () => {
        setIsRecording(false)
      }
      
      recognitionRef.current.onend = () => {
        setIsRecording(false)
      }
    }
  }, [])

  // Registrar usu√°rio no sistema de treinamento + Iniciar avalia√ß√£o IMRE automaticamente
  useEffect(() => {
    console.log('üîç useEffect - user:', user?.name, 'hasWelcomed:', hasWelcomed, 'sentInitialMessage:', sentInitialMessage, 'shouldStartAssessment:', shouldStartAssessment)
    
    if (user && !hasWelcomed && !sentInitialMessage && shouldStartAssessment) {
      console.log('‚úÖ Condi√ß√£o satisfeita! Registrando usu√°rio e enviando IMRE...')
      
      // Mapear tipo de usu√°rio para o sistema de treinamento
      let role = 'professional' as 'developer' | 'admin' | 'professional' | 'observer'
      if (user.type === 'admin') role = 'admin'
      else if (user.type === 'professional') role = 'professional'
      else if (user.type === 'patient') role = 'professional' // Paciente como professional
      else role = 'observer'
      
      trainingSystem.registerUser(user.id, user.name || 'Usu√°rio', role, ['full'])
      setHasWelcomed(true)
      setSentInitialMessage(true) // Marcar que j√° enviou
      
      console.log('üìù Iniciando avalia√ß√£o IMRE automaticamente...')
      
      // Enviar mensagem IMRE automaticamente (SEMPRE quando abre o chat vindo do dashboard)
      const imrePrompt = `Ol√° N√¥a! Sou ${user.name} e gostaria de realizar uma Avalia√ß√£o Cl√≠nica Inicial seguindo o protocolo IMRE (Investiga√ß√£o, Metodologia, Resultado, Evolu√ß√£o) da Arte da Entrevista Cl√≠nica aplicada √† Cannabis Medicinal. Por favor, inicie o protocolo IMRE para minha avalia√ß√£o cl√≠nica inicial e, ao final, gere um relat√≥rio cl√≠nico que ser√° salvo no meu dashboard.`
      
      console.log('üí¨ Mensagem IMRE:', imrePrompt)
      
      // Primeiro inicializar
      setIsInitialized(true)
      
      // Enviar automaticamente como se o usu√°rio tivesse digitado
      // Usar requestAnimationFrame para garantir que o estado foi atualizado
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          console.log('‚è∞ Executando handleSendMessageAutomatically...')
          handleSendMessageAutomatically(imrePrompt)
        })
      })
    } else {
      console.log('‚ö†Ô∏è Condi√ß√£o N√ÉO satisfeita - user:', !!user, 'hasWelcomed:', hasWelcomed, 'sentInitialMessage:', sentInitialMessage)
    }
  }, [user, hasWelcomed, sentInitialMessage])
  
  // Fun√ß√£o para enviar mensagem automaticamente
  const handleSendMessageAutomatically = async (message: string) => {
    // Proteger contra execu√ß√£o duplicada
    if (sendingRef.current) {
      console.log('‚ö†Ô∏è Mensagem j√° sendo enviada, ignorando duplicata...')
      return
    }
    
    sendingRef.current = true
    console.log('üöÄ handleSendMessageAutomatically chamado! Enviando mensagem IMRE...')
    
    const userMessage = {
      role: 'user' as const,
      content: message,
      timestamp: new Date()
    }
    setMessages([userMessage])
    setIsTyping(true)
    
    try {
      // Registrar no sistema de treinamento
      trainingSystem.addConversationMessage({
        role: 'user',
        content: message,
        context: {
          route: '/app/patient-noa-chat',
          userCode: user?.id || '',
          userId: user?.id || ''
        }
      })
      
      // Processar com IA (h√≠brido)
      const response = await assistantIntegration.sendMessage(
        message,
        user?.id,
        '/app/patient-noa-chat'
      )
      
      const noaMessage = {
        role: 'noa' as const,
        content: response.content,
        timestamp: new Date()
      }
      
      setMessages(prev => [...prev, noaMessage])
      
      // Parar loading
      setIsTyping(false)
      
      // Registrar resposta da N√¥a
      trainingSystem.addConversationMessage({
        role: 'noa',
        content: response.content,
        context: {
          route: '/app/patient-noa-chat',
          userCode: user?.id || '',
          userId: user?.id || ''
        }
      })
      
      // LER a mensagem com voz feminina (se habilitado)
      if (audioEnabled) {
        speakWithVoice(response.content)
      }
    } catch (error) {
      console.error('Erro ao processar mensagem:', error)
      setIsTyping(false)
      setIsResponding(false)
    } finally {
      sendingRef.current = false // Liberar para pr√≥xima mensagem
    }
  }

  const handleSendMessage = async () => {
    const message = inputMessage.trim()
    if (!message || isTyping || !isInitialized) return

    // Adicionar mensagem do usu√°rio
    const userMessage = {
      role: 'user' as const,
      content: message,
      timestamp: new Date()
    }
    setMessages(prev => [...prev, userMessage])
    setInputMessage('') // Limpar campo imediatamente
    setIsTyping(true)

    try {
      // Registrar no sistema de treinamento
      trainingSystem.addConversationMessage({
        role: 'user',
        content: message,
        context: {
          route: '/app/patient-noa-chat',
          userCode: user?.id || '',
          userId: user?.id || ''
        }
      })

      // Processar com IA (h√≠brido - MESMO do bal√£o)
      const response = await assistantIntegration.sendMessage(
        message,
        user?.id,
        '/app/patient-noa-chat'
      )

      const noaMessage = {
        role: 'noa' as const,
        content: response.content,
        timestamp: new Date()
      }

      setMessages(prev => [...prev, noaMessage])
      
      // Parar loading
      setIsTyping(false)
      
      // Registrar resposta da N√¥a
      trainingSystem.addConversationMessage({
        role: 'noa',
        content: response.content,
        context: {
          route: '/app/patient-noa-chat',
          userCode: user?.id || '',
          userId: user?.id || ''
        }
      })
      
      // LER a mensagem com voz feminina (se habilitado)
      if (audioEnabled) {
        speakWithVoice(response.content)
      }
    } catch (error) {
      console.error('Erro ao processar mensagem:', error)
      setIsTyping(false)
      setIsResponding(false)
    }
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }
  }
  
  // Iniciar/parar grava√ß√£o de voz
  const toggleRecording = () => {
    if (!recognitionRef.current) {
      alert('‚ö†Ô∏è Reconhecimento de voz n√£o dispon√≠vel neste navegador')
      return
    }
    
    if (isRecording) {
      recognitionRef.current.stop()
      setIsRecording(false)
      console.log('‚èπÔ∏è Grava√ß√£o parada')
    } else {
      recognitionRef.current.start()
      setIsRecording(true)
      console.log('üé§ Gravando...')
    }
  }

  return (
    <div className="bg-slate-900 min-h-screen flex flex-col">
      {/* Header */}
      <div className="flex items-center justify-between p-6 border-b border-slate-800">
        <button 
          onClick={() => navigate('/app/patient-dashboard')}
          className="flex items-center space-x-2 text-slate-300 hover:text-white transition-colors"
        >
          <ArrowLeft className="w-5 h-5" />
          <span>Voltar</span>
        </button>
        <div className="text-center flex items-center justify-center space-x-3">
          <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
            <Brain className="w-6 h-6 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-white">N√¥a Esperan√ßa</h1>
            <p className="text-slate-300 text-sm">IA Residente - Especializada em Avalia√ß√µes Cl√≠nicas</p>
          </div>
        </div>
        
        {/* Bot√£o de controle de √°udio */}
        <button
          onClick={() => {
            setAudioEnabled(!audioEnabled)
            if (audioEnabled) {
              window.speechSynthesis.cancel()
            }
          }}
          className="flex items-center space-x-2 text-slate-300 hover:text-white transition-colors"
          title={audioEnabled ? 'Desativar √°udio' : 'Ativar √°udio'}
        >
          {audioEnabled ? (
            <>
              <Volume2 className="w-5 h-5" />
              <span>√Åudio ON</span>
            </>
          ) : (
            <>
              <VolumeX className="w-5 h-5" />
              <span>√Åudio OFF</span>
            </>
          )}
        </button>
      </div>

      {/* Main Content - Layout Livre */}
      <div className="flex-1 flex items-center justify-center p-8">
        {/* Container Central */}
        <div className="w-full max-w-5xl mx-auto">
          {/* Avatar da N√¥a no Centro com Video */}
          <div className="flex justify-center mb-8">
            <div className="w-64 h-64 rounded-full overflow-hidden shadow-2xl border-4 border-purple-500/30 relative">
              {/* Video da N√¥a com transi√ß√£o suave */}
              <video
                key={isResponding ? 'responding' : 'idle'}
                src={isResponding ? '/AGENTEFALANDO.mp4' : '/estatica piscando.mp4'}
                autoPlay
                loop
                muted
                playsInline
                className="w-full h-full object-cover transition-opacity duration-500"
                onLoadedData={(e) => {
                  e.currentTarget.style.opacity = '1'
                }}
                onError={(e) => {
                  console.warn('‚ùå Erro ao carregar video, usando avatar')
                  e.currentTarget.style.display = 'none'
                }}
              />
              {/* Fallback - Avatar est√°tico */}
              <img 
                src={avatarUrl} 
                alt="N√¥a Esperan√ßa" 
                className="w-full h-full object-cover hidden"
                onError={(e) => {
                  console.warn('‚ùå Erro ao carregar avatar, usando gradiente')
                  e.currentTarget.style.display = 'none'
                  e.currentTarget.nextElementSibling?.classList.remove('hidden')
                }}
              />
              {/* Fallback final - Gradient */}
              <div className="w-full h-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center hidden">
                <Brain className="w-24 h-24 text-white" />
              </div>
            </div>
          </div>

          {/* Chat abaixo do avatar */}
          <div className="flex flex-col max-w-3xl mx-auto">

          {/* Messages Area - Sem Card */}
          <div className="flex-1 overflow-y-auto p-6 space-y-4 min-h-[400px]">
              {messages.length === 0 ? (
                <div className="text-center py-12">
                  <h4 className="text-white font-semibold mb-4 text-xl">Ol√°, {user?.name || 'Paciente'}!</h4>
                  <p className="text-slate-300 mb-6">
                    Sou a N√¥a Esperan√ßa, sua IA Residente.
                  </p>
                  <div className="bg-slate-700/50 rounded-lg p-4 text-left max-w-md mx-auto">
                    <p className="text-xs text-slate-300 mb-3 font-semibold">Posso ajudar com:</p>
                    <ul className="text-xs text-slate-400 space-y-2">
                      <li className="flex items-start">
                        <span className="mr-2">‚Ä¢</span>
                        <span>Perguntas sobre a plataforma</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2">‚Ä¢</span>
                        <span>Informa√ß√µes sobre tratamentos</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2">‚Ä¢</span>
                        <span>D√∫vidas sobre funcionalidades</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2">‚Ä¢</span>
                        <span>Orienta√ß√µes gerais de sa√∫de</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2">‚Ä¢</span>
                        <span>Avalia√ß√µes cl√≠nicas com protocolo IMRE</span>
                      </li>
                    </ul>
                  </div>
                  <p className="text-sm text-slate-500 mt-6">
                    üå¨Ô∏è Bons ventos soprem!
                  </p>
                </div>
              ) : (
                messages.map((message, index) => (
                  <div
                    key={index}
                    className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[75%] px-4 py-3 rounded-lg ${
                        message.role === 'user'
                          ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                          : 'bg-slate-700 text-slate-100'
                      }`}
                    >
                      <div className="whitespace-pre-wrap">{message.content}</div>
                      <div className={`text-xs mt-1 ${
                        message.role === 'user' ? 'text-purple-100' : 'text-slate-400'
                      }`}>
                        {message.timestamp.toLocaleTimeString('pt-BR', { 
                          hour: '2-digit', 
                          minute: '2-digit' 
                        })}
                      </div>
                    </div>
                  </div>
                ))
              )}

              {isTyping && (
                <div className="flex justify-start">
                  <div className="bg-slate-700 px-4 py-3 rounded-lg">
                    <div className="flex space-x-2">
                      <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" />
                      <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }} />
                      <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }} />
                    </div>
                  </div>
                </div>
              )}
          </div>

          {/* Input Area */}
          <div className="p-4 mt-4">
            <div className="flex items-center space-x-3">
              <input
                type="text"
                value={inputMessage}
                onChange={(e) => setInputMessage(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Pergunte √† N√¥a..."
                className="flex-1 px-6 py-4 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              {/* Bot√£o de grava√ß√£o de voz */}
              <button
                onClick={toggleRecording}
                disabled={isTyping || !isInitialized}
                className={`p-4 rounded-xl transition-colors ${
                  isRecording
                    ? 'bg-red-600 hover:bg-red-700 text-white'
                    : 'bg-slate-700 hover:bg-slate-600 text-slate-300'
                } disabled:opacity-50 disabled:cursor-not-allowed`}
                title={isRecording ? 'Parar grava√ß√£o' : 'Gravar mensagem de voz'}
              >
                {isRecording ? (
                  <MicOff className="w-6 h-6" />
                ) : (
                  <Mic className="w-6 h-6" />
                )}
              </button>
              {/* Bot√£o de enviar */}
              <button
                onClick={handleSendMessage}
                disabled={!inputMessage.trim() || isTyping || !isInitialized}
                className="p-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isTyping ? (
                  <Loader2 className="w-6 h-6 animate-spin" />
                ) : (
                  <Send className="w-6 h-6" />
                )}
              </button>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default PatientNOAChat